import { readOneEmail } from "./readEmail.js";
import { detectCategory } from "./classifier.js";
import { analyzeLead } from "./gemini.js";
import { addReplyToSheet } from "./googleSheet.js";
import { sendAutoReply } from "./email.js";

export function startAutoEmailProcessing(interval = 60000) {
    console.log("ğŸ¤– Auto Email Processor Running...");

    setInterval(async () => {
        console.log("ğŸ” Checking email...");

        try {
            const email = await readOneEmail();
            if (!email) {
                console.log("ğŸ“­ No new email");
                return;
            }

            console.log("ğŸ“© From:", email.from);
            console.log("ğŸ“ Subject:", email.subject);

            // 1ï¸âƒ£ ØªØ´Ø®ÛŒØµ Ø¯Ø³ØªÙ‡
            const category = await detectCategory(email.text);

            // 2ï¸âƒ£ ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø® AI
            const result = await analyzeLead(category, email.text);

            // 3ï¸âƒ£ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheet
            await addReplyToSheet(
                email.name || "Unknown",
                email.from,
                email.text,
                category,
                result.reply
            );

            // 4ï¸âƒ£ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø§ØªÙˆÙ…Ø§Øª
            const sent = await sendAutoReply(email.from, result.reply, category);

            console.log("ğŸ§  Category:", category);
            console.log("âœ‰ï¸ Email sent:", sent);
            console.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

        } catch (err) {
            console.error("âŒ Auto process error:", err);
        }
    }, interval);
}

import fetch from "node-fetch";
import dotenv from "dotenv";
dotenv.config();

const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

export async function detectCategory(message) {
    const prompt = `
        Classify the following customer message into ONE of these categories:
        - support
        - sales
        - complaint
        - general

        Message:
        "${message}"

        Only return the category name.
    `;

    const response = await fetch(GEMINI_API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-goog-api-key": process.env.GEMINI_API_KEY
        },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });

    const data = await response.json();
    return data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toLowerCase() || "general";
}

import nodemailer from "nodemailer";

const transporter = nodemailer.createTransport({
    service: "gmail",
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
    },
});

export async function sendAutoReply(email, reply, category) {
    if (!email) return false;
    if (process.env.AUTO_EMAIL !== "true") return false;

    let subject = "Thanks for contacting us";
    if (category === "support") subject = "Support request received";
    else if (category === "sales") subject = "Pricing & Sales inquiry";
    else if (category === "complaint") subject = "Complaint received";

    try {
        await transporter.sendMail({
            from: `"Support Team" <${process.env.EMAIL_USER}>`,
            to: email,
            subject,
            text: reply,
        });
        return true;
    } catch (err) {
        console.error("Email send error:", err);
        return false;
    }
}

import fetch from "node-fetch";
import dotenv from "dotenv";
dotenv.config();

const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

export async function analyzeLead(category, message) {
    const prompt = `
        You are an AI sales/support assistant.
        Category: ${category}
        Customer message: ${message}

        Write a short, friendly, professional reply that encourages the customer to continue the conversation.
    `;

    try {
        if (!process.env.GEMINI_API_KEY) {
            return { reply: "Thanks for reaching out! We'll reply shortly." };
        }

        const response = await fetch(GEMINI_API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-goog-api-key": process.env.GEMINI_API_KEY
            },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Gemini API error:", errorText);
            throw new Error("Gemini API failed");
        }

        const data = await response.json();
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, no response";

        return { reply: text };

    } catch (err) {
        console.error("Gemini error details:", err);
        return { reply: "Sorry, an error occurred while generating a reply." };
    }
}

import { google } from "googleapis";
import dotenv from "dotenv";
dotenv.config();

const auth = new google.auth.GoogleAuth({
  keyFile: "service-account.json",
  scopes: ["https://www.googleapis.com/auth/spreadsheets"]
});

const sheets = google.sheets({ version: "v4", auth });

export async function addReplyToSheet(name, email, message, category, reply) {
  if (!process.env.SPREADSHEET_ID) throw new Error("SPREADSHEET_ID missing");

  await sheets.spreadsheets.values.append({
    spreadsheetId: process.env.SPREADSHEET_ID,
    range: "Sheet1!A:E",
    valueInputOption: "RAW",
    requestBody: { values: [[name, email, message, category, reply]] }
  });
}

import Imap from "imap";
import { simpleParser } from "mailparser";
import dotenv from "dotenv";
dotenv.config();

const imapConfig = {
    user: process.env.EMAIL_USER,
    password: process.env.EMAIL_PASS,
    host: "imap.gmail.com",
    port: 993,
    tls: true,
    tlsOptions: { rejectUnauthorized: false }
};

export function readOneEmail() {
    return new Promise((resolve, reject) => {
        const imap = new Imap(imapConfig);

        imap.once("ready", () => {
            imap.openBox("INBOX", false, (err) => {
                if (err) return reject(err);

                imap.search(["UNSEEN"], (err, results) => {
                    if (err || !results || results.length === 0) {
                        imap.end();
                        return resolve(null);
                    }

                    // âœ… Ø¢Ø®Ø±ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ù‚Ø¹ÛŒ
                    const latest = results[results.length - 1];

                    const f = imap.fetch(latest, { bodies: "" });

                    f.on("message", (msg) => {
                        msg.on("body", (stream) => {
                            simpleParser(stream, (err, parsed) => {
                                if (err) return reject(err);

                                imap.addFlags(latest, "\\Seen", () => {
                                    imap.end();
                                    resolve({
                                        from: parsed.from?.value?.[0]?.address,
                                        name: parsed.from?.value?.[0]?.name,
                                        subject: parsed.subject,
                                        text: parsed.text
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        imap.once("error", reject);
        imap.connect();
    });
}

// routes 
import express from "express";
import { google } from "googleapis";
import dotenv from "dotenv";
import analyzeRoute from "./routes/analyze.js";
import emailsRoute from "./routes/emails.js";
dotenv.config();

const router = express.Router();
const auth = new google.auth.GoogleAuth({ keyFile: "service-account.json", scopes: ["https://www.googleapis.com/auth/spreadsheets"] });
const sheets = google.sheets({ version: "v4", auth });

router.get("/emails", async (req, res) => {
    try {
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: process.env.SPREADSHEET_ID,
            range: "Sheet1!A:E"
        });

        const rows = response.data.values || [];
        const emails = rows.map((row, idx) => ({
            id: idx + 1,
            name: row[0],
            email: row[1],
            message: row[2],
            category: row[3],
            reply: row[4] || "",
            replied: !!row[4]
        }));

        res.json(emails);
    } catch (err) {
        console.error(err);
        res.status(500).json([]);
    }
});
app.get("/responses", async (req, res) => {
    // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù‡Ù…Ø§Ù† Google Sheet ÛŒØ§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ù†Ú¯Ø§Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    try {
        const auth = new google.auth.GoogleAuth({ keyFile: "service-account.json", scopes: ["https://www.googleapis.com/auth/spreadsheets"] });
        const sheets = google.sheets({ version: "v4", auth });
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: process.env.SPREADSHEET_ID,
            range: "Sheet1!A:E"
        });

        const rows = response.data.values || [];
        const responses = rows.map((row, idx) => ({
            id: idx + 1,
            to: row[1],
            subject: row[2],
            reply: row[4] || "",
            status: row[4] ? "Sent" : "Pending",
            time: row[5] || ""
        }));

        res.json(responses);
    } catch (err) {
        console.error(err);
        res.status(500).json([]);
    }
});

/**
 * ğŸ”¹ Ø¢Ù†Ø§Ù„ÛŒØ² Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø±
 * GET /dashboard/analytics
 * ØªØ¹Ø¯Ø§Ø¯ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡ Ùˆ Sentiment
 */
app.get("/analytics", async (req, res) => {
    try {
        const auth = new google.auth.GoogleAuth({ keyFile: "service-account.json", scopes: ["https://www.googleapis.com/auth/spreadsheets"] });
        const sheets = google.sheets({ version: "v4", auth });
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: process.env.SPREADSHEET_ID,
            range: "Sheet1!A:E"
        });

        const rows = response.data.values || [];

        const categories: Record<string, number> = {};
        const sentiment = { positive: 0, negative: 0, neutral: 0 };

        rows.forEach(row => {
            const cat = row[3] || "general";
            categories[cat] = (categories[cat] || 0) + 1;

            // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø³ØªÙˆÙ† F (index 5) sentiment ÛŒØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ reply Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´ÙˆØ¯
            const s = row[5] || "neutral";
            if (s === "positive") sentiment.positive += 1;
            else if (s === "negative") sentiment.negative += 1;
            else sentiment.neutral += 1;
        });

        res.json({ categories, sentiment });
    } catch (err) {
        console.error(err);
        res.status(500).json({ categories: {}, sentiment: { positive: 0, negative: 0, neutral: 0 } });
    }
});

/**
 * ğŸ”¹ Google Sheets Ú©Ø§Ù…Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
 * GET /dashboard/sheets
 */
app.get("/sheets", async (req, res) => {
    try {
        const auth = new google.auth.GoogleAuth({ keyFile: "service-account.json", scopes: ["https://www.googleapis.com/auth/spreadsheets"] });
        const sheets = google.sheets({ version: "v4", auth });
        const response = await sheets.spreadsheets.values.get({
            spreadsheetId: process.env.SPREADSHEET_ID,
            range: "Sheet1!A:F"
        });

        const rows = response.data.values || [];
        const entries = rows.map((row, idx) => ({
            id: idx + 1,
            date: row[0],
            sender: row[1],
            subject: row[2],
            message: row[3],
            response: row[4],
            status: row[5] || "Pending"
        }));

        res.json(entries);
    } catch (err) {
        console.error(err);
        res.status(500).json([]);
    }
});

export default router;

import express from "express";
import { analyzeLead } from "../services/gemini.js";
import { addReplyToSheet } from "../services/googleSheet.js";
import { detectCategory } from "../services/classifier.js";
import { sendAutoReply } from "../services/email.js";

const router = express.Router();

/**
 * POST /analyze
 * body: { message, name?, email?, category? }
 */
router.post("/", async (req, res) => {
    let { category, message, name, email } = req.body;

    if (!message) {
        return res.status(400).json({ error: "message required" });
    }

    try {
        // ğŸ§  ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø³ØªÙ‡
        if (!category) {
            category = await detectCategory(message);
        }

        // ğŸ¤– ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø® AI
        const { reply } = await analyzeLead(category, message);

        // ğŸ“Š Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheet
        await addReplyToSheet(
            name || "Unknown",
            email || "N/A",
            message,
            category,
            reply
        );

        // ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ (Ø¯Ø± ØµÙˆØ±Øª ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù†)
        const emailSent = await sendAutoReply(email, reply, category);

        // âœ… Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ API
        res.json({
            category,
            reply,
            emailSent
        });

    } catch (err) {
        console.error("Analyze route error:", err);
        res.status(500).json({ error: "Server error" });
    }
});

export default router;
